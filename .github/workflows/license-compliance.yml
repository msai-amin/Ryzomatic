name: License Compliance

on:
  schedule:
    - cron: '0 10 * * 1' # Monday 10 AM UTC
  pull_request:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

# Security: Restrict permissions to minimum required
permissions:
  contents: read
  pull-requests: read

jobs:
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --no-audit
      
      - name: Install license-checker and jq
        run: |
          npm install -g license-checker
          sudo apt-get update && sudo apt-get install -y jq || true
      
      - name: Generate license report
        run: |
          echo "Generating license report..."
          license-checker --json > licenses.json 2>&1 || true
          license-checker --summary > licenses-summary.txt 2>&1 || true
          
          # Generate detailed report
          ALLOWED_LICENSES="MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;Public Domain;CC0-1.0;LGPL-2.1;LGPL-3.0"
          license-checker --onlyAllow "$ALLOWED_LICENSES" --excludePrivatePackages > allowed-licenses.txt 2>&1 || true
      
      - name: Check for problematic licenses
        id: license-check
        run: |
          echo "Checking for problematic licenses..."
          
          PROBLEMATIC=false
          PROBLEMATIC_LICENSES=""
          
          # Only deny AGPL-3.0 (most restrictive copyleft license)
          # GPL-2.0 and GPL-3.0 are allowed (will show as warnings)
          DENIED_LICENSES=("AGPL-3.0")
          
          # Check for denied licenses in summary
          for license in "${DENIED_LICENSES[@]}"; do
            if grep -qi "$license" licenses-summary.txt; then
              echo "‚ùå Denied license found: $license"
              echo "Packages with $license:"
              grep -i "$license" licenses-summary.txt | head -10
              PROBLEMATIC=true
              PROBLEMATIC_LICENSES="${PROBLEMATIC_LICENSES}${license}, "
            fi
          done
          
          # Check for GPL licenses (warning only, not blocking)
          if grep -qi "GPL-2.0\|GPL-3.0" licenses-summary.txt; then
            echo "‚ö†Ô∏è  Warning: GPL-2.0 or GPL-3.0 licenses found (allowed for dev dependencies)"
            echo "If these are production dependencies, consider alternatives."
            grep -i "GPL-2.0\|GPL-3.0" licenses-summary.txt | head -5
          fi
          
          # Check for unknown/unlicensed packages (warning only)
          if grep -qi "UNKNOWN\|UNLICENSED\|NOASSERTION" licenses-summary.txt; then
            echo "‚ö†Ô∏è  Warning: Some packages have unknown licenses"
            echo "This is common for internal packages or packages without explicit licenses."
            grep -i "UNKNOWN\|UNLICENSED\|NOASSERTION" licenses-summary.txt | head -10
          fi
          
          if [ "$PROBLEMATIC" = true ]; then
            echo "problematic=true" >> $GITHUB_OUTPUT
            echo "problematic_licenses=${PROBLEMATIC_LICENSES%, }" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ No problematic licenses found"
          echo "problematic=false" >> $GITHUB_OUTPUT
      
      - name: Generate license summary
        if: always()
        run: |
          echo "# üìã License Compliance Report" > license-report.md
          echo "" >> license-report.md
          echo "**Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> license-report.md
          echo "" >> license-report.md
          
          if [ -f licenses-summary.txt ]; then
            echo "## License Summary" >> license-report.md
            echo "\`\`\`" >> license-report.md
            cat licenses-summary.txt >> license-report.md
            echo "\`\`\`" >> license-report.md
          fi
          
          echo "" >> license-report.md
          echo "## Status" >> license-report.md
          if [ "${{ steps.license-check.outputs.problematic }}" = "true" ]; then
            echo "‚ùå **FAILED** - Denied licenses detected: ${{ steps.license-check.outputs.problematic_licenses }}" >> license-report.md
          else
            echo "‚úÖ **PASSED** - No denied licenses found" >> license-report.md
          fi
      
      - name: Upload license report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report-${{ github.sha }}
          path: |
            licenses.json
            licenses-summary.txt
            license-report.md
          retention-days: 90
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('license-report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
      
      - name: Fail on denied licenses
        if: steps.license-check.outputs.problematic == 'true'
        run: |
          echo "‚ùå License compliance check failed!"
          echo "Denied licenses: ${{ steps.license-check.outputs.problematic_licenses }}"
          echo ""
          echo "Please review and remove packages with denied licenses, or update the deny list if appropriate."
          exit 1
