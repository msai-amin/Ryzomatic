name: Secret Scanning

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

# Security: Restrict permissions to minimum required
permissions:
  contents: read
  pull-requests: read

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        # Security: Pin to specific commit SHA instead of version tag for supply chain security
        # Example: uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for secret scanning

      - name: Run TruffleHog Secret Scan
        # Security: Pin to specific commit SHA instead of version tag for supply chain security
        # Note: This is a backup to GitHub's built-in secret scanning
        # GitHub's built-in secret scanning is enabled at repository settings level
        # To enable: Settings > Security > Code security and analysis > Secret scanning
        # Using trufflesecurity/trufflehog (OSS version) as trufflehog-action is deprecated
        continue-on-error: true  # Don't fail the workflow if TruffleHog finds issues
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Documentation
        run: |
          echo "## Secret Scanning Setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow runs TruffleHog as a backup to GitHub's built-in secret scanning." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Built-in Secret Scanning" >> $GITHUB_STEP_SUMMARY
          echo "GitHub's built-in secret scanning is configured at the repository settings level:" >> $GITHUB_STEP_SUMMARY
          echo "- Navigate to: Settings > Security > Code security and analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Enable 'Secret scanning' for push protection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### TruffleHog" >> $GITHUB_STEP_SUMMARY
          echo "This workflow runs TruffleHog as an additional layer of protection." >> $GITHUB_STEP_SUMMARY

