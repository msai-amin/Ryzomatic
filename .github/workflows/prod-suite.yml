name: Production Test Suite

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Production base URL (optional override)'
        required: false
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC

jobs:
  probes:
    name: HTTP Probes
    runs-on: ubuntu-latest
    env:
      PROD_URL: ${{ inputs.url || secrets.PROD_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show target
        run: |
          echo "Target: ${PROD_URL}"
          if [ -z "${PROD_URL}" ]; then
            echo "PROD_URL secret not set"; exit 1;
          fi

      - name: Probe homepage (allow 200/3xx/401)
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}")
          echo "status=$code"
          case "$code" in
            200|301|302|304|401) exit 0 ;;
            *) echo "Unexpected status $code"; exit 1 ;;
          esac

      - name: Probe health endpoint
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL%/}/api/health")
          echo "status=$code"
          case "$code" in
            200|204|401) exit 0 ;;
            *) echo "Unexpected status $code"; exit 1 ;;
          esac

      - name: Probe highlights endpoint (warn on failure)
        continue-on-error: true
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL%/}/api/highlights")
          echo "status=$code"
          case "$code" in
            200|204|401) exit 0 ;;
            *) echo "Warning: Unexpected status $code"; exit 0 ;;
          esac

      - name: Probe OCR status (warn on >=500)
        continue-on-error: true
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL%/}/api/documents?action=ocr-status")
          echo "status=$code"
          case "$code" in
            200|204|401) exit 0 ;;
            5*) echo "Warning: Server error $code"; exit 0 ;;
            *) echo "Unexpected status $code"; exit 1 ;;
          esac

  lighthouse:
    name: Lighthouse (Desktop)
    runs-on: ubuntu-latest
    needs: probes
    env:
      PROD_URL: ${{ inputs.url || secrets.PROD_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm install

      - name: Run Lighthouse CI
        env:
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: prod-suite
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.run_id }}
        run: |
          if [ -z "${PROD_URL}" ]; then
            echo "PROD_URL secret not set"; exit 1;
          fi
          npx @lhci/cli autorun --collect.url="${PROD_URL}" --collect.settings.preset=desktop || echo "Lighthouse warnings allowed"

  smoke:
    name: Playwright Smoke
    runs-on: ubuntu-latest
    needs: probes
    env:
      PLAYWRIGHT_BROWSERS_PATH: 0
      PROD_URL: ${{ inputs.url || secrets.PROD_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm install

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Create smoke test (inline)
        run: |
          mkdir -p tests
          cat > tests/prod.suite.smoke.spec.ts <<'TS'
          import { test, expect } from '@playwright/test';
          const base = process.env.PROD_URL!;
          test('homepage responds and has a title', async ({ page }) => {
            if (!base) test.skip(true, 'PROD_URL not set');
            const errors: string[] = [];
            page.on('pageerror', (e) => { errors.push(`pageerror: ${e.message}`); });
            page.on('console', (msg) => { if (msg.type() === 'error') errors.push(`console error: ${msg.text()}`); });
            const resp = await page.goto(base, { waitUntil: 'domcontentloaded' });
            expect(resp).not.toBeNull();
            const status = resp!.status();
            expect([200, 301, 302, 304, 401]).toContain(status);
            const title = await page.title();
            expect(title.length).toBeGreaterThan(0);
            expect(errors.length).toBeLessThan(3);
          });
          TS

      - name: Run smoke tests
        run: npx playwright test tests/prod.suite.smoke.spec.ts --timeout=60000

      - name: Archive Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            playwright-report/**
            test-results/**


