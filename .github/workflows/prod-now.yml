name: Production Checks (On-Demand)

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Override production URL (optional)'
        required: false

jobs:
  probes:
    name: API & Homepage Probes
    runs-on: ubuntu-latest
    env:
      PROD_URL: ${{ inputs.url || secrets.PROD_URL }}
    steps:
      - name: Validate PROD_URL
        run: |
          if [ -z "$PROD_URL" ]; then
            echo "PROD_URL is not set. Configure repository secret PROD_URL or provide an input." >&2
            exit 1
          fi
          echo "Target: $PROD_URL"

      - name: Homepage
        run: |
          CODE=$(curl -sSL -o /dev/null -w "%{http_code}\n" "$PROD_URL")
          echo "homepage: $CODE"
          # Accept 200 or 401 for auth-guarded landing
          if [ "$CODE" != "200" ] && [ "$CODE" != "401" ]; then exit 1; fi

      - name: Health endpoint
        run: |
          CODE=$(curl -sSL -o /dev/null -w "%{http_code}\n" "$PROD_URL/api/health")
          echo "health: $CODE"
          if [ "$CODE" != "200" ] && [ "$CODE" != "401" ]; then exit 1; fi

      - name: Highlights endpoint (unauthenticated)
        run: |
          CODE=$(curl -sSL -o /dev/null -w "%{http_code}\n" "$PROD_URL/api/highlights")
          echo "highlights: $CODE"
          # Expect 401/405 when unauthenticated
          if [ "$CODE" != "401" ] && [ "$CODE" != "405" ]; then exit 1; fi

      - name: OCR status probe (unauthenticated)
        run: |
          CODE=$(curl -sSL -o /dev/null -w "%{http_code}\n" "$PROD_URL/api/documents?action=ocr-status&documentId=invalid")
          echo "ocr-status: $CODE"
          # Allow 500 as warning (missing server env), otherwise accept 400/401/404
          if [ "$CODE" = "500" ]; then
            echo "::warning::/api/documents?action=ocr-status returned 500 (check SUPABASE_* env). Proceeding."
            exit 0
          fi
          if [ "$CODE" != "401" ] && [ "$CODE" != "400" ] && [ "$CODE" != "404" ]; then
            exit 1
          fi

  lighthouse:
    name: Lighthouse (Desktop)
    runs-on: ubuntu-latest
    needs: probes
    env:
      PROD_URL: ${{ inputs.url || secrets.PROD_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Lighthouse CI
        run: npm i -g @lhci/cli@0.12.x

      - name: Run Lighthouse
        run: |
          if [ -z "$PROD_URL" ]; then
            echo "PROD_URL is not set. Configure repository secret PROD_URL or provide an input." >&2
            exit 1
          fi
          lhci collect --url="$PROD_URL" --numberOfRuns=3 --settings.preset=desktop --settings.throttlingMethod=provided || true
          lhci upload --target=temporary-public-storage || true


